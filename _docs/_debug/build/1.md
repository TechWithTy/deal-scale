# Next.js Build Error Remediation Plan

## 1. Top-Level Await in `page.tsx`
- **Root Issue:** Top-level `await` is not supported in your current Next.js target environment.
- **Fix:** Refactor any top-level `await` into an `async` function, such as a React Server Component or a data-fetching function.
- **Edge Cases:** Move dynamic imports or async logic at the top level inside functions/components.

## 2. React Hook Errors
**a. Hooks in Callbacks**
- **Root Issue:** Hooks must be called at the top level of React function components or custom hooks.
- **Fix:** Move all `useEffect` (and other hooks) calls to the top level of your components or custom hooks, not inside callbacks or conditionals.

**b. Missing Dependencies in useEffect**
- **Root Issue:** Not all variables used inside `useEffect` are listed in its dependency array.
- **Fix:** Add all referenced variables/functions to the dependency array. Memoize inline functions with `useCallback` if needed.
- **Edge Cases:** If adding a dependency causes unwanted re-renders, refactor code to avoid inline function definitions or move logic outside of `useEffect`.

## 3. Fast Refresh/Only Export Components
- **Root Issue:** Files exporting both components and non-component code break React Fast Refresh and Next.js conventions.
- **Fix:** Move non-component exports (constants, helpers, etc.) to separate files. Only export React components from component files.
- **Edge Cases:** Context providers and hooks should also be in their own files if they are exported.

## 4. ESLint Next.js Plugin Not Detected
- **Root Issue:** ESLint config is missing the Next.js plugin.
- **Fix:** Add `next` to your ESLint plugins and extend `next/core-web-vitals`.
- **Edge Cases:** Ensure custom ESLint rules do not conflict with Next.js recommendations.

## 5. General Linting/TypeScript Errors
- **Root Issue:** Type errors and lint errors (e.g., incorrect prop types, missing/extra properties).
- **Fix:** Address all TypeScript errors as reported in the build output. Ensure all function signatures match usage. Use type hints and interfaces for all API and component props.
- **Edge Cases:** Check for mismatches in API request/response types, especially with external APIs. Ensure environment variables are present and correctly typed.

## 6. Edge Cases & Best Practices
- **Async/Await Compatibility:** Ensure Node.js version and Next.js config support all async/await features you use.
- **Component Isolation:** Ensure every React component is in its own file if possible, especially for contexts and hooks.
- **Testing:** Add or update tests to cover edge cases, especially for API routes and data fetching.
- **Environment Variables:** Validate that all required `.env` variables are present and correct.
- **CI/CD:** Run `pnpm build` and `pnpm lint` in your CI pipeline to catch errors before deployment.

## 7. Step-by-Step Remediation Order
1. Fix top-level await in `page.tsx`.
2. Resolve all React hook usage errors.
3. Move non-component exports out of component files.
4. Update ESLint config for Next.js.
5. Fix all remaining TypeScript and lint errors.
6. Validate environment variables.
7. Re-run `pnpm build` and confirm success.
8. Add or update tests to prevent regressions.

## 8. Not-Found Page Build Error (Vercel)
### Issue:
- Vercel build fails with `Error occurred prerendering page "/_not-found"` and `ReferenceError: document is not defined`, even though local build passes.

### Steps We Tried:
- Ensured only `src/app/not-found.tsx` exists (no `_not-found` or `/page.tsx` variants).
- Ran `find src/app -iname "*not-found*"` and `git ls-files src/app` to confirm no stray files.
- Verified `git status` is clean, with nothing to commit.
- Confirmed local build and fresh clones work perfectly (`pnpm build`).
- Checked Vercel is using latest commit and correct root directory/build command.
- Attempted Vercel redeploys (with and without cache).

### What Did NOT Work:
- Vercel still attempts to prerender `/_not-found/page` despite codebase being clean.
- No hidden, untracked, or deleted files found in repo.
- No monorepo or subdirectory misconfiguration.

### Next Steps:
- Double-check Vercel project settings (root directory, build command, output directory).
- Ensure Vercel is building the latest commit (commit hash matches local).
- If issue persists, try deleting and recreating the Vercel project.
- Contact Vercel support if error continues after all above steps.

---

## Remediation Log

### 1. Top-Level Await in `page.tsx`
- **Original Issue:** Top-level await (`const previewPosts = (await getAllPosts());`) is not supported in the current environment.
- **Action:** Refactored `src/app/blogs/[slug]/page.tsx` to move `getAllPosts()` fetching into a `useEffect` and `useState` within the `BlogPostPage` component.
- **Result:** Top-level await error resolved; build should now proceed further.
- **Note:** Lint warning about `useEffect` missing dependency (`previewPosts`) is benign here because `previewPosts` is only set, not read, in the effect. Will monitor for any issues.
- **Status:** 

### 2. React Hook Errors
- **Original Issue:** (To be checked after fixing top-level await)
- **Action:** Next step is to scan for and fix any hooks called inside callbacks, and address missing dependency warnings.
- **Status:** In progress.

### 3. Fast Refresh/Only Export Components
- **Original Issue:** (To be checked after fixing hook errors)
- **Action:** Not yet started.

### 4. ESLint Next.js Plugin Not Detected
- **Original Issue:** (To be checked after fixing hook errors)
- **Action:** Not yet started.

### 5. General Linting/TypeScript Errors
- **Original Issue:** (To be checked after fixing hook errors)
- **Action:** Not yet started.

---

*This log will be updated as fixes are attempted, what worked, and what did not, for each remediation step.*

**Document all new findings and steps here as you continue debugging.**