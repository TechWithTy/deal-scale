name: Security

on:
  workflow_call:
    inputs:
      registry:
        required: true
        type: string
      image_name:
        required: true
        type: string
      snyk_enabled:
        required: false
        type: string
        default: 'false'
      snyk_severity:
        required: false
        type: string
        default: 'high'

jobs:
  security:
    runs-on: ubuntu-latest
    env:
      IMAGE_REGISTRY: ${{ inputs.registry }}
      IMAGE_NAME: ${{ inputs.image_name }}
      IMAGE_FULL: ${{ inputs.registry }}/${{ github.repository_owner }}/${{ inputs.image_name }}
      IMAGE_TAG: ${{ github.sha }}
      SNYK_SEVERITY: ${{ inputs.snyk_severity }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Trivy FS scan (vuln/secret/misconfig)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-report.json'
          scanners: 'vuln,secret,misconfig'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
          skip-dirs: 'node_modules,.git'

      - name: Trivy config (IaC) SARIF
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          format: 'sarif'
          output: 'trivy-config.sarif'
          severity: 'HIGH,CRITICAL'

      - name: Build Docker image for scan
        run: |
          docker build -t "$IMAGE_FULL:$IMAGE_TAG" .

      - name: Trivy image scan (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_FULL }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-image.sarif'
          vuln-type: 'os,library'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'

      - name: Snyk Open Source scan (CLI Docker)
        if: ${{ inputs.snyk_enabled == 'true' && secrets.SNYK_TOKEN != '' }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          docker run --rm \
            -e SNYK_TOKEN \
            -v "${{ github.workspace }}":/project \
            -w /project \
            snyk/snyk:docker snyk test --all-projects --severity-threshold=${SNYK_SEVERITY} \
              --sarif-file-output=snyk-os.sarif || true

      - name: Upload Snyk Open Source SARIF
        if: ${{ inputs.snyk_enabled == 'true' && secrets.SNYK_TOKEN != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: snyk-os-sarif
          path: snyk-os.sarif

      - name: Snyk Container scan (built image)
        if: ${{ inputs.snyk_enabled == 'true' && secrets.SNYK_TOKEN != '' }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          docker run --rm \
            -e SNYK_TOKEN \
            -v /var/run/docker.sock:/var/run/docker.sock \
            snyk/snyk:docker snyk container test "${{ env.IMAGE_FULL }}:${{ env.IMAGE_TAG }}" \
              --severity-threshold=${SNYK_SEVERITY} \
              --json-file-output=snyk-container.json || true

      - name: Upload Snyk Container JSON
        if: ${{ inputs.snyk_enabled == 'true' && secrets.SNYK_TOKEN != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: snyk-container-json
          path: snyk-container.json

      - name: Upload Trivy JSON report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-json
          path: trivy-report.json

      - name: Upload Trivy SARIF reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif
          path: |
            trivy-config.sarif
            trivy-image.sarif
